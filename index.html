<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5M9PGYFQNR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-5M9PGYFQNR');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Ring</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-size: cover;
            background-position: center;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        #topControls {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            background: #e0e3f3;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #mainContent {
            display: flex;
            flex: 1;
            justify-content: space-between;
            padding: 20px;
        }
        #output {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);

            text-align: center;
            overflow-y: auto;
            max-height: 70vh;
        }

        #teamTotal {
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #tableContainer {
            width: 48%;

        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        #timerDisplay {
            font-size: 1.5em;
            font-weight: bold;
            color: #d9534f;
            margin-right: 20px;
        }
        p {
            font-size: 1.2em;
            color: #333;
        }
        strong {
            color: #007BFF;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            color: black;
            background-color: #91c400;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        .retryBtn {
            background-color: #FA4141;
        }
         .leftRight {
              background-color: #838f95;
              color: white;
              padding: 4px 8px;
              border-radius: 4px;

         }
         .loadQuestion {
              background-color: #91c400;
              color: white;
              padding: 4px 8px;
              border-radius: 4px;
         }

         .clearQuestion {
              background-color: #FA4141;
              color: white;
              padding: 4px 8px;
              border-radius: 4px;
         }

        button:disabled {
            background-color: gray;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        #muteBtn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }


        .highlighted-row {
            background-color: #ffe6e6; /* світло-червоний фон */
        }
          #leftPanel, #tableContainer {
            display: flex;
            flex-direction: column;
            width: 49.5%;
            gap: 10px;
            height: auto;
         }


<!--        #question, #output {-->
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 38vh;
            text-align: center;
            height: 48%;
        }

        #question {
          display: flex;
          flex-direction: column;
        }
        #questionDisplay {
          flex: 1;
          overflow-y: auto;
          margin-bottom: 10px; /* відступ перед кнопками */
        }



        .button-wrapper {
          background: white;
          padding: 10px;
          text-align: center;
         }
         .total {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px;
            background-color: #f7f7f7;
         }
         .total > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.05);
            font-family: sans-serif;
         }

        .team-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .team-points {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
        }

        .content {
          flex: 1;
          overflow-y: auto;

        }
        .container {
          position: relative;
          display: flex;
          flex-direction: column;
          overflow-y: auto;
          height: 100%; /* or fixed height like 400px */
        }
        .element {
          display: none;
          margin-top: 15px;
          padding: 15px;
          background-color: #e0f7fa;
          border: 1px solid #00796b;
          border-radius: 6px;
        }
     //для роботи з табами
        .tabs {
             display: flex;
             flex-direction: row;
             flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 6px;
            border-bottom: 2px solid #ccc;
            margin-bottom: 16px;
            padding-bottom: 6px;
            background-color: #f9f9f9;
            border-radius: 8px 8px 0 0;
    }

    .tab {
        display: inline-flex;   /* або просто не вказувати display */
        white-space: nowrap;
        padding: 10px 20px;
        background-color: #eaeaea;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        font-weight: 500;
        color: #333;
        transition: all 0.3s ease;
    }

    .tab.active {
        background-color: white;
        border: 1px solid #ccc;
        border-bottom: none;
        font-weight: bold;
        color: #007bff;
        z-index: 2;
        box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
    }

    .tab:hover {
        background-color: #dcdcdc;
   }

    .tab-content {
         display: none;
        padding: 20px;
        border: 1px solid #ccc;
        border-top: none;
        background-color: #fff;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .tab-content.active {
      display: block;
    }

          .circle-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #4CAF50;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background-color 0.3s;
    }

    .circle-button:hover {
      background-color: #45a049;
    }
    .button-group {
        display: flex;
        justify-content: flex-end; /* кнопки праворуч */
        gap: 10px;                 /* відстань між кнопками */
        margin-top: 10px;
    }
    .selector {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-left: 10px;
      background: #f1f1f1;
      padding: 5px 10px;
      border-radius: 8px;
      font-weight: bold;
    }

    .selector button {
      padding: 2px 6px;
      font-size: 1em;
      border-radius: 4px;
      background: #ddd;
      border: none;
      cursor: pointer;
    }

    .selector button:hover {
      background: #ccc;
    }



/* Для планшетів у портретному режимі (наприклад, iPad Air 13) */
    @media only screen and (max-width: 1024px) {
    #mainContent {
        flex-direction: column;
        padding: 10px;
    }

    #leftPanel, #tableContainer {
        width: 100%;
    }

    .total {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .button-wrapper {
        flex-wrap: wrap;
        justify-content: center;
    }

    #topControls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }

    .selector {
        margin: 5px 0;
        justify-content: center;
    }

    button {
        font-size: 0.9em;
        padding: 8px 12px;
    }
}

html {
    font-size: 16px;
}

@media (max-width: 768px) {
    html {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    html {
        font-size: 12px;
    }
}

table {
    width: 100%;
    font-size: 0.95em;
}

input[type="number"] {
    width: 100%;
    box-sizing: border-box;
}


/* === Покращення стилю topControls === */
#topControls {
    flex-wrap: wrap;
    gap: 10px;
    position: sticky;
    top: 0;
    z-index: 1000;
    background: #e0e3f3;
}

/* Менші кнопки у селекторах та retry */
#topControls .selector,
#topControls button.retryBtn,
#topControls button,
#topControls img {
    font-size: 0.85em;
    padding: 4px 8px;
    margin: 0;
}

#topControls img {
    width: 28px;
    height: 28px;
}

/* Для малих екранів */
@media only screen and (max-width: 1024px) {
    #topControls {
        flex-direction: row;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 6px;
        padding: 6px 10px;
    }

    #topControls .selector,
    #topControls button.retryBtn,
    #topControls button {
        font-size: 0.8em;
        padding: 3px 6px;
    }

    #topControls img {
        width: 24px;
        height: 24px;
    }
}


    @media only screen and (max-width: 1024px) {
    #leftPanel {
        height: auto;
        gap: 10px;
    }

    #output {
        height: 25vh !important;
        max-height: 25vh !important;
        overflow-y: auto;
    }
    #question {
        height: 20vh !important;
        max-height: 25vh !important;
        overflow-y: auto;
    }

    #questionDisplay {
        max-height: 180px;
        font-size: 0.9em;
    }

    .button-wrapper {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
    }
    }
    @media only screen and (max-width: 1024px) {
        #question {
            margin-bottom: 10px;
        }

        #mainContent {
            padding-bottom: 10px;
        }
    }
        @media only screen and (max-width: 1024px) {
            .element {
                max-height: 80px;
                overflow: hidden;
            }
        }

        @media only screen and (max-width: 1024px) {
            #mainContent {
                padding: 10px 10px 5px 10px; /* зменшує нижній padding */
                gap: 10px; /* додає контрольовану відстань між блоками */
            }
        }
        /* Сховати колонку команди у таблицях */
            body.hide-red table th:nth-child(2),
            body.hide-red table td:nth-child(2),
            body.hide-green table th:nth-child(3),
            body.hide-green table td:nth-child(3),
            body.hide-blue table th:nth-child(4),
            body.hide-blue table td:nth-child(4),
            body.hide-white table th:nth-child(5),
            body.hide-white table td:nth-child(5),
            body.hide-yellow table th:nth-child(6),
            body.hide-yellow table td:nth-child(6),
            body.hide-pink table th:nth-child(7),
            body.hide-pink table td:nth-child(7) {
                display: none !important;
            }

            /* Сховати блок команди у #teamTotal */
            body.hide-red #teamTotal > div:nth-child(1),
            body.hide-green #teamTotal > div:nth-child(2),
            body.hide-blue #teamTotal > div:nth-child(3),
            body.hide-white #teamTotal > div:nth-child(4),
            body.hide-yellow #teamTotal > div:nth-child(5),
            body.hide-pink #teamTotal > div:nth-child(6) {
                display: none !important;
            }



            .tab-content {
                 max-height: 57vh;
                 overflow-y: auto;
            }




    </style>
</head>
<body>
<div id="topControls">
    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div id="timerDisplay" style="min-width: 100px; color: #d9534f; font-weight: bold;"></div>
        <button id="timer1Btn" onclick="startTimer(60)">Start 1-Min</button>
        <button id="timer2Btn" onclick="startTimer(120)">Start 2-Min</button>
        <button class="retryBtn" onclick="resetOutput()">Retry</button>
    </div>
    <div id="questionSelector" class="selector">
        <label>Question:</label>
        <button onclick="changeQuestion(-1)">◀</button>
        <span id="questionValue">1</span>
        <button onclick="changeQuestion(1)">▶</button>
    </div>
    <div id="roundSelector" class="selector">
        <label>Round:</label>
        <button onclick="changeRound(-1)">◀</button>
        <span id="roundValue">2</span>
        <button onclick="changeRound(1)">▶</button>
    </div>

    <button class="retryBtn" onclick="retrySession()">Retry Session</button>
    <div style="position: relative;">
        <img id="muteIcon" src="icon/mute_17879746.png" alt="Mute" style="width: 25px; height: 25px; cursor: pointer;" onclick="toggleMute()">
        <img id="settingsIcon" src="https://cdn-icons-png.flaticon.com/512/2099/2099058.png" alt="Settings"
             style="width: 25px; height: 25px; cursor: pointer; margin-left: 10px;" onclick="toggleSettingsMenu()">

        <div id="settingsMenu" style="display: none; position: absolute; top: 30px; right: 0; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); padding: 10px; z-index: 1000;">
            <label><input type="checkbox" data-team="red" checked> Red</label><br>
            <label><input type="checkbox" data-team="green" checked> Green</label><br>
            <label><input type="checkbox" data-team="blue" checked> Blue</label><br>
            <label><input type="checkbox" data-team="white" checked> White</label><br>
            <label><input type="checkbox" data-team="yellow" checked> Yellow</label><br>
            <label><input type="checkbox" data-team="pink" checked> Pink</label>
        </div>
    </div>


</div>

<div id="mainContent">
    <div id="leftPanel">
        <div id="output"><p>Lets the battle begin!</p>
        </div>
        <div>
            <div id="element1" class="element">Green
                <button class="circle-button" id="addGreen1">+1</button>
                <button class="circle-button" id="addGreen2">+2</button>
                <button class="circle-button" id="addGreen3">+3</button>
            </div>
            <div id="element2" class="element">Red
                <button class="circle-button" id="addRed1">+1</button>
                <button class="circle-button" id="addRed2">+2</button>
                <button class="circle-button" id="addRed3">+3</button>
            </div>
            <div id="element3" class="element">Blue
                <button class="circle-button" id="addBlue1">+1</button>
                <button class="circle-button" id="addBlue2">+2</button>
                <button class="circle-button" id="addBlue3">+3</button>
            </div>
            <div id="element4" class="element">White
                <button class="circle-button" id="addWhite1">+1</button>
                <button class="circle-button" id="addWhite2">+2</button>
                <button class="circle-button" id="addWhite3">+3</button>
            </div>
            <div id="element5" class="element">Yellow
                <button class="circle-button" id="addYellow1">+1</button>
                <button class="circle-button" id="addYellow2">+2</button>
                <button class="circle-button" id="addYellow3">+3</button>
            </div>
            <div id="element6" class="element">Pink
                <button class="circle-button" id="addPink1">+1</button>
                <button class="circle-button" id="addPink2">+2</button>
                <button class="circle-button" id="addPink3">+3</button>
            </div>
        </div>
        <div id="question" class="container">
            <div id="questionDisplay" class="content" style="margin-top: 10px;">
                <p><strong>Question Number:</strong> <span id="qNumber">-</span></p>
                <p><strong>Question:</strong> <span id="qText">No question loaded</span></p>
            </div>
            <div class="button-wrapper">
                <input class="leftRight" type="file" id="csvUpload" accept=".csv">
                <button class="loadQuestion" onclick="loadCSV()">Load Questions</button>
                <button class="clearQuestion" onclick="clearCSV()">Clear Questions</button>
                <button class="leftRight" onclick="prevQuestion()">Previous</button>
                <button class="leftRight" onclick="nextQuestion()">Next</button>
            </div>
        </div>
    </div>
    <div id="tableContainer">
        <div class="total" id="teamTotal">
            <div>
                <span class="team-name">Red Team</span>
                <span class="team-points" id="points-red"></span>
            </div>
            <div >
                <span class="team-name">Green team</span>
                <span class="team-points" id="points-green"></span>
            </div>
            <div >
                <span class="team-name">Blue team</span>
                <span class="team-points" id="points-blue"></span>
            </div>
            <div >
                <span class="team-name">White team</span>
                <span class="team-points" id="points-white"></span>
            </div>
            <div>
                <span class="team-name">Yellow team</span>
                <span class="team-points" id="points-yellow"></span>
            </div>
            <div>
                <span class="team-name">Pink Team</span>
                <span class="team-points" id="points-pink"></span>
            </div>
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="tab1">Yes / No round</div>
            <div class="tab" data-tab="tab2">Simple questions round</div>
            <div class="tab" data-tab="tab3">Hard question round</div>
            <div class="tab" data-tab="tab4">Captains round</div>
        </div>

        <div class="tab-content active" id="tab1">
            <h2>Yes/No</h2>
            <table id="tableYesNo">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Red</th>
                    <th>Green</th>
                    <th>Blue</th>
                    <th>White</th>
                    <th>Yellow</th>
                    <th>Pink</th>
                </tr>
                </thead>
            </table>
        </div>

        <div class="tab-content" id="tab2">
            <h2>Simple questions</h2>
            <table id="tableSimple">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Red</th>
                    <th>Green</th>
                    <th>Blue</th>
                    <th>White</th>
                    <th>Yellow</th>
                    <th>Pink</th>
                </tr>
                </thead>
            </table>
        </div>

        <div class="tab-content" id="tab3">
            <h2>Hard Questions</h2>
            <table id="tableHard">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Red</th>
                    <th>Green</th>
                    <th>Blue</th>
                    <th>White</th>
                    <th>Yellow</th>
                    <th>Pink</th>
                </tr>
                </thead>
            </table>
        </div>
        <div class="tab-content" id="tab4">
            <h2>Captain's round</h2>
            <table id="tableCap">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Red</th>
                    <th>Green</th>
                    <th>Blue</th>
                    <th>White</th>
                    <th>Yellow</th>
                    <th>Pink</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Audio Elements -->
<audio id="soundG" src="audio/mixkit-car-horn-718.wav"></audio>
<audio id="soundR" src="audio/mixkit-cartoon-blow-impact-2654.wav"></audio>
<audio id="soundB" src="audio/mixkit-impact-of-a-blow-2150.wav"></audio>
<audio id="soundW" src="audio/mixkit-bonus-collect-award-1937.wav"></audio>
<audio id="soundY" src="audio/mixkit-fairy-arcade-sparkle-866.wav"></audio>
<audio id="soundP" src="audio/mixkit-retro-game-notification-212.wav"></audio>
<audio id="soundOff" src="audio/mixkit-sad-game-over-trombone).mp3"></audio>
<audio id="soundBackground1" src="audio/last10secondAudio.mp3"></audio>

<script>
    let lastClickTime = 0;
    let clickTimes = [];
    let listening = true;
    let timer;
    let countdown;
    let isMuted = false;
    let warningTimeout;

    let clickedTeams = {
        green: false,
        blue: false,
        red: false,
        white: false,
        yellow: false,
        pink: false
    };

    document.addEventListener('keydown', (event) => {
        if (!listening) return;

        const currentTime = new Date().getTime();
        let message = "";
        let team = "";

        const keyMap = {
            g: { team: "green", elementId: "element1" }, п: { team: "green", elementId: "element1" },
            b: { team: "blue", elementId: "element3" }, и: { team: "blue", elementId: "element3" },
            r: { team: "red", elementId: "element2" }, к: { team: "red", elementId: "element2" },
            w: { team: "white", elementId: "element4" }, ц: { team: "white", elementId: "element4" },
            y: { team: "yellow", elementId: "element5" }, н: { team: "yellow", elementId: "element5" },
            p: { team: "pink", elementId: "element6" }, з: { team: "pink", elementId: "element6" }
        };

        const pressedKey = event.key.toLowerCase();
        const mapping = keyMap[pressedKey];
        if (!mapping || clickedTeams[mapping.team]) return;

        clickedTeams[mapping.team] = true;

        // Play sound
        document.getElementById(`sound${mapping.team.charAt(0).toUpperCase()}`).play();

        // Calculate time difference
        let timeText = "First";
        if (lastClickTime !== 0) {
            const timeDifference = (currentTime - lastClickTime) / 1000;
            const formattedTime = timeDifference.toFixed(2).replace('.', ',');
            timeText = `+ <strong style='color:red;'>${formattedTime} s</strong>`;
            clickTimes.push(timeDifference);
        }

        lastClickTime = currentTime;

        // Show corresponding hidden element as a new block in order
        const element = document.getElementById(mapping.elementId);
        const cloned = element.cloneNode(true);
        cloned.style.display = 'block';

        const title = document.createElement('div');
        title.innerHTML = `<strong style="color:${mapping.team};">${mapping.team.charAt(0).toUpperCase() + mapping.team.slice(1)} team clicked</strong> | ${timeText}`;

        cloned.innerHTML = '';
        const inlineWrap = document.createElement('div');
        inlineWrap.style.display = 'flex';
        inlineWrap.style.alignItems = 'center';
        inlineWrap.style.justifyContent = 'space-between';
        inlineWrap.style.flexWrap = 'wrap';
        inlineWrap.style.gap = '10px';

        inlineWrap.appendChild(title);

        const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';

            ['+1', '+2', '+3'].forEach((label, index) => {
                const btn = document.createElement('button');
                btn.className = 'circle-button';
                btn.textContent = label;

                btn.addEventListener('click', () => {
                    const roundValue = parseInt(document.getElementById('roundValue').textContent);
                    const questionValue = parseInt(document.getElementById('questionValue').textContent);

                    let tableId = '';
                    if (roundValue === 2) tableId = 'tableSimple';
                    else if (roundValue === 3) tableId = 'tableHard';
                    else if (roundValue === 4) tableId = 'tableCap';
                    else return; // якщо round не підтримується — нічого не робимо

                    const table = document.getElementById(tableId);
                    if (!table) return;

                    const rowIndex = questionValue - 1; // бо індексація з 0
                    const teamOrder = ['red', 'green', 'blue', 'white', 'yellow', 'pink'];
                    const colIndex = teamOrder.indexOf(mapping.team);
                    if (colIndex === -1) return;

                    const tbody = table.querySelector('tbody');
                    const rows = tbody.querySelectorAll('tr');
                    const sumRowIndex = rows.length - 1;
                    if (rowIndex >= sumRowIndex) return;

                    const targetRow = rows[rowIndex];
                    const input = targetRow.querySelectorAll('input')[colIndex];
                    if (!input) return;

                    const current = parseFloat(input.value) || 0;
                    input.value = current + (index + 1);
                    input.dispatchEvent(new Event('input')); // тригер оновлення суми
                });


                buttonGroup.appendChild(btn); // ✅ Додаємо кнопку у групу
            });

            inlineWrap.appendChild(buttonGroup);
            cloned.appendChild(inlineWrap);

        cloned.classList.add('element');
        document.getElementById('output').appendChild(cloned);
    });


    function saveState() {
        const table = document.querySelector('table');
        if (!table) return;

        const headers = [...table.querySelectorAll('thead th')].slice(1).map(th => th.textContent);
        const rows = [...table.querySelectorAll('tbody tr')].slice(0, -1);
        const data = rows.map(tr => [...tr.querySelectorAll('select')].map(select => select.value));
        localStorage.setItem('tableState', JSON.stringify({ headers, data }));
    }

    function startTimer(duration) {
        clearTimeout(warningTimeout);
        const bgAudio = document.getElementById('soundBackground1');
        bgAudio.pause();
        bgAudio.currentTime = 0;
        listening = true;
        document.getElementById('output').innerHTML += `<p><strong style='color:green;'>Timer started for ${duration / 60} minutes! Press keys now.</strong></p>`;
        document.getElementById('timer1Btn').disabled = true;
        document.getElementById('timer2Btn').disabled = true;

         if (duration === 60) {
            warningTimeout = setTimeout(() => {
            document.getElementById('soundBackground1').play();
        }, 50000);

    } else if (duration === 120) {
                warningTimeout = setTimeout(() => {
                    document.getElementById('soundBackground1').play();
                }, 110000);
        }

        let timeLeft = duration;
        document.getElementById('timerDisplay').innerText = `Time Left: ${timeLeft}s`;

        countdown = setInterval(() => {
            timeLeft--;
            document.getElementById('timerDisplay').innerText = `Time Left: ${timeLeft}s`;
            if (timeLeft <= 0) clearInterval(countdown);
        }, 1000);

        timer = setTimeout(() => {
            listening = false;
            document.getElementById('output').innerHTML += "<p><strong style='color:red;'>Time's up! Keyboard input stopped.</strong></p>";
            document.getElementById('timerDisplay').innerText = "Time's up!";
            document.getElementById('soundOff').play();
            saveState();
        }, duration * 1000);
    }

    function resetOutput() {
        document.getElementById('output').innerHTML = "<p>Lets the battle begin!</p>";
        document.getElementById('timerDisplay').innerText = "";
        lastClickTime = 0;
        clickTimes = [];

        // Скидаємо всі таймери
        clearTimeout(timer);
        clearInterval(countdown);
        clearTimeout(warningTimeout);

        listening = true;

        document.getElementById('timer1Btn').disabled = false;
        document.getElementById('timer2Btn').disabled = false;

        for (let key in clickedTeams) clickedTeams[key] = false;

        // Зупиняємо всі звуки
        document.querySelectorAll('audio').forEach(audio => {
            audio.pause();
            audio.currentTime = 0;
        });

        // Показати приховані елементи (якщо вони існують)
        const gameContainer = document.getElementById('gameContainer');
        if (gameContainer) gameContainer.style.display = 'block';
        const questionContainer = document.getElementById('questionContainer');
        if (questionContainer) questionContainer.style.display = 'block';
        const scoreTable = document.getElementById('scoreTable');
        if (scoreTable) scoreTable.style.display = 'block';

        // Сховати Retry, якщо він існує
        const retryBtn = document.getElementById('retryBtn');
        if (retryBtn) retryBtn.style.display = 'none';
    }


        function resetTable() {
            const confirmReset = confirm("Are you sure you want to reset the table? You will lose all data.");
            if (!confirmReset) return;

            document.getElementById('tableContainer').innerHTML = "";
            localStorage.removeItem('tableState');
        }


    function toggleMute() {
        isMuted = !isMuted;
        document.querySelectorAll('audio').forEach(audio => audio.muted = isMuted);
        document.getElementById('muteIcon').src = isMuted ? "icon/muted_3541927.png" : "icon/mute_17879746.png";
        saveState();
    }
        function buildInputTable(tableId, rowCount, allowedValues) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const headerRow = table.querySelector("thead tr");
            const teamCount = headerRow.children.length - 1; // exclude '#'

            const tbody = document.createElement("tbody");

            // Створити основні рядки
            for (let i = 1; i <= rowCount; i++) {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${i}</td>`;
                for (let j = 0; j < teamCount; j++) {
                    const input = document.createElement("input");
                    input.type = "number";
                    input.step = "0.5";
                    input.min = Math.min(...allowedValues);
                    input.max = Math.max(...allowedValues);
                    input.setAttribute("data-col", j);
                    input.addEventListener("input", () => {
                    updateColumnSums(tableId);
                    saveTableState(tableId);

                    if (tableId === "tableSimple") {
                        applyConditionalFormattingSimple();
                    } else if (tableId === "tableHard") {
                        applyConditionalFormattingHard();
                    } else if (tableId === "tableCap") {
                        applyConditionalFormattingCap();
                    }
                    });
                    row.appendChild(document.createElement("td")).appendChild(input);
                }
                tbody.appendChild(row);
            }

            // Додати рядок для сум
            const sumRow = document.createElement("tr");
            sumRow.className = "sumRow";
            sumRow.innerHTML = "<td><strong>Sum</strong></td>";
            for (let i = 0; i < teamCount; i++) {
                const cell = document.createElement("td");
                cell.className = "sumCell";
                cell.innerText = "0";
                sumRow.appendChild(cell);
            }

            tbody.appendChild(sumRow);
            table.appendChild(tbody);
        }

        function saveTableState(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const inputs = table.querySelectorAll("input[data-col]");
            const data = [];

          inputs.forEach(input => {
                data.push(input.value);
            });

            localStorage.setItem(`tableData-${tableId}`, JSON.stringify(data));
        }


        function updateColumnSums(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const inputs = table.querySelectorAll("input[data-col]");
            const sumCells = table.querySelectorAll(".sumRow .sumCell");

            const colSums = Array.from(sumCells).map(() => 0);
            inputs.forEach(input => {
                const col = parseInt(input.getAttribute("data-col"));
                const val = parseFloat(input.value);
                if (!isNaN(val)) {
                    colSums[col] += val;
                }
            });

            sumCells.forEach((cell, i) => cell.textContent = colSums[i]);
            updateTeamTotalsFromTable(tableId);
            updateTotalTeamPoints();
        }

        // Ініціалізація після завантаження сторінки
        window.addEventListener("DOMContentLoaded", () => {
            const savedRound = localStorage.getItem('roundValue');
            const savedQuestion = localStorage.getItem('questionValue');

            if (savedRound) {
                round = parseInt(savedRound);
                document.getElementById('roundValue').textContent = round;
            }

            if (savedQuestion) {
                question = parseInt(savedQuestion);
                document.getElementById('questionValue').textContent = question;
            }
            buildInputTable("tableYesNo", 1, Array.from({length: 101}, (_, i) => i));       // довільні числа
            loadTableState("tableYesNo");
            buildInputTable("tableSimple", 40, [1, 2]);                                      // тільки 1 або 2
            loadTableState("tableSimple");
            buildInputTable("tableHard", 20, [1, 2, 3]);                                     // 1, 2, 3
            loadTableState("tableHard");
            buildInputTable("tableCap", 15, Array.from({length: 11}, (_, i) => i - 5));
            loadTableState("tableCap");

            const savedCSV = localStorage.getItem('uploadedCSV');
            if (savedCSV) {
                questionsData = savedCSV.split("\n").map(row => row.split(";"));
                currentQuestionIndex = 0;
                showQuestion();
            }
            updateTotalTeamPoints();
        });

        function loadTableState(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const data = JSON.parse(localStorage.getItem(`tableData-${tableId}`));
            if (!data) return;

            const inputs = table.querySelectorAll("input[data-col]");
            inputs.forEach((input, index) => {
                input.value = data[index] || "";
            });

            updateColumnSums(tableId); // ⬅️ оновлює суми після відновлення
        }


        function handleCSVUpload() {
                    const fileInput = document.getElementById('csvUpload');
            const file = fileInput.files[0];

            if (!file) {
                alert("Please select a CSV file first.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const csvContent = e.target.result;
                localStorage.setItem('uploadedCSV', csvContent);
                alert("CSV file uploaded and saved.");
                currentRowIndex = 0;
                parsedCSV = parseCSV(csvContent);
                displayRow(currentRowIndex);
            };
            reader.readAsText(file);
        }


        function getCSVFromLocalStorage() {
            const csv = localStorage.getItem('uploadedCSV');
            if (!csv) return [];

            const rows = csv.trim().split("\n");
            return rows.map(row => row.split(","));
        }

    //Questions functionality

         let questionsData = [];
            let currentQuestionIndex = 0;

            function loadCSV() {
                const fileInput = document.getElementById('csvUpload');
                const file = fileInput.files[0];
                if (!file) {
                    alert("Please select a CSV file first.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const csvContent = e.target.result.trim();
                    localStorage.setItem('uploadedCSV', csvContent);

                    questionsData = csvContent.split("\n").map(row => row.split(";"));
                    currentQuestionIndex = 0;
                    showQuestion();
                };
                reader.readAsText(file);
            }

            function showQuestion() {
                if (!questionsData.length) return;

                const row = questionsData[currentQuestionIndex];
                const qNumber = row[0] || "N/A";
                const qText = row[1] || "No question";

                document.getElementById('qNumber').textContent = qNumber;
                document.getElementById('qText').textContent = qText;
            }

            function nextQuestion() {
                if (currentQuestionIndex < questionsData.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                }
            }

            function prevQuestion() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    showQuestion();
                }
            }

         function clearCSV() {
            const confirmReset = confirm("Click OK if you want to remove all loaded questions.");
            if (!confirmReset) return;

            localStorage.removeItem('uploadedCSV');
            questionsData = [];
            currentQuestionIndex = 0;

            // Очистити питання з UI
            document.getElementById('qNumber').textContent = "-";
            document.getElementById('qText').textContent = "No question loaded";

            document.getElementById('output').innerHTML = "<p>Questions cleared. You can load a new CSV file.</p>";
        }

//Question functionality ends

//Скрипт для табів
     const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Знімаємо клас активності з усіх табів і контенту
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));

        // Додаємо активний клас до натиснутої вкладки та відповідного контенту
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');

         if (tab.dataset.tab === "tab1") {
              applyConditionalFormattingYesNo?.();
            } else if (tab.dataset.tab === "tab2") {
              applyConditionalFormattingSimple?.();
            } else if (tab.dataset.tab === "tab3") {
              applyConditionalFormattingHard?.();
            } else if (tab.dataset.tab === "tab4") {
              applyConditionalFormattingCap?.();
            }
      });
    });

//Скрипт для табі закінчився

    function retrySession() {
        const confirmClear = confirm("Are you sure you want to clear all table data and start a new session?");
        if (!confirmClear) return;

        const tableIds = ["tableYesNo", "tableSimple", "tableHard", "tableCap"];

        tableIds.forEach(tableId => {
            // Видаляємо з localStorage
          localStorage.removeItem(`tableData-${tableId}`);

            // Очищаємо значення в таблиці
            const table = document.getElementById(tableId);
            if (!table) return;

            const inputs = table.querySelectorAll("input[data-col]");
            inputs.forEach(input => {
                input.value = "";
            });

            updateColumnSums(tableId); // оновити суму після очищення
            });
            localStorage.removeItem('roundValue');
            localStorage.removeItem('questionValue');
            round = 2;
            question = 1;
            document.getElementById('roundValue').textContent = round;
            document.getElementById('questionValue').textContent = question;
            clearTimeout(warningTimeout);
            const bgAudio = document.getElementById('soundBackground1');
            bgAudio.pause();
            bgAudio.currentTime = 0;
            alert("All table data cleared. You can start a new session.");
        }
        function updateTeamTotalsFromTable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const sumCells = table.querySelectorAll(".sumRow .sumCell");
            const teamIds = ["red", "green", "blue", "white", "yellow", "pink"];

            sumCells.forEach((cell, index) => {
                const value = cell.textContent.trim();
                const pointsElement = document.getElementById(`points-${teamIds[index]}`);
                if (pointsElement) {
                    pointsElement.textContent = value;
                }
            });
        }
        function updateTotalTeamPoints() {
            const tableIds = ["tableYesNo", "tableSimple", "tableHard", "tableCap"];
            const teamIds = ["red", "green", "blue", "white", "yellow", "pink"];
            const totals = Array(teamIds.length).fill(0); // створюємо масив з 6 нулями

            tableIds.forEach(tableId => {
                const table = document.getElementById(tableId);
                if (!table) return;

                const sumCells = table.querySelectorAll(".sumRow .sumCell");
                sumCells.forEach((cell, i) => {
                    const value = parseFloat(cell.textContent);
                    if (!isNaN(value)) {
                        totals[i] += value;
                    }
                });
            });

            // Оновити текстові значення у відповідних блоках
            teamIds.forEach((team, i) => {
                const el = document.getElementById(`points-${team}`);
                if (el) el.textContent = totals[i].toFixed(1);
            });
        }

            let round = 2;
            let question = 1;

            function changeRound(delta) {
                round = Math.min(4, Math.max(2, round + delta));
                document.getElementById('roundValue').textContent = round;
                localStorage.setItem('roundValue', round);
                // Додай сюди дію, яка відбувається при зміні раунду

                question = 1;
                document.getElementById('questionValue').textContent = question;
                localStorage.setItem('questionValue', question);
                resetOutput();
            }

            function changeQuestion(delta) {
                question = Math.min(40, Math.max(1, question + delta));
                document.getElementById('questionValue').textContent = question;
                localStorage.setItem('questionValue', question);
                // Додай сюди дію, яка відбувається при зміні питання
                if (delta === 1) {
                  nextQuestion();
                } else if (delta === -1) {
                  prevQuestion();
                }
                resetOutput();

            }

        function applyConditionalFormattingSimple() {
            const table = document.getElementById('tableSimple');
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr:not(.sumRow)');

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                let filledValues = 0;
                let hasTooLarge = false;

                inputs.forEach(input => {
                    const val = parseFloat(input.value);
                    if (!isNaN(val)) {
                        filledValues++;
                        if (val > 2) hasTooLarge = true;
                    }
                });

                // умовне забарвлення
                if (filledValues === 1 && !hasTooLarge) {
                    row.style.backgroundColor = '#d4edda'; // світло-зелений
                } else if (filledValues > 1 || hasTooLarge) {
                    row.style.backgroundColor = '#f8d7da'; // світло-червоний
                } else {
                    row.style.backgroundColor = ''; // скидання
                }
            });
        }

        function applyConditionalFormattingHard() {
            const table = document.getElementById('tableHard');
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr:not(.sumRow)');

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                let filledValues = 0;
                let hasTooLarge = false;

                inputs.forEach(input => {
                    const val = parseFloat(input.value);
                    if (!isNaN(val)) {
                        filledValues++;
                        if (val > 3) hasTooLarge = true;
                    }
                });

                if (filledValues === 1 && !hasTooLarge) {
                    row.style.backgroundColor = '#d4edda'; // світло-зелений
                } else if (filledValues > 1 || hasTooLarge) {
                    row.style.backgroundColor = '#f8d7da'; // світло-червоний
                } else {
                    row.style.backgroundColor = ''; // скинути стиль
                }
            });
        }

        function applyConditionalFormattingCap() {
    const table = document.getElementById('tableCap');
    if (!table) return;

    const rows = table.querySelectorAll('tbody tr:not(.sumRow)');

    rows.forEach(row => {
        const rowNumberCell = row.querySelector('td');
        const rowNumber = parseInt(rowNumberCell?.textContent);

        // 🟡 Пропускаємо перший логічний рядок (#1)
        if (rowNumber === 1) {
            row.style.backgroundColor = '';
            return;
        }

        const inputs = row.querySelectorAll('input');
        let filledCount = 0;
        let hasNotOne = false;

        inputs.forEach(input => {
            const val = parseFloat(input.value);
            if (!isNaN(val)) {
                filledCount++;
                if (val !== 1) {
                    hasNotOne = true;
                }
            }
        });

        if (filledCount === 1 && !hasNotOne) {
            row.style.backgroundColor = '#d4edda'; // ✅ зелений
        } else if (filledCount > 1 || hasNotOne) {
            row.style.backgroundColor = '#f8d7da'; // ❌ червоний
        } else {
            row.style.backgroundColor = ''; // 🔄 скидання
        }
    });
}
    function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {

            // === СТАРТ: Відновлення стану чекбоксів для видимості команд ===
                const checkboxes = document.querySelectorAll('#settingsMenu input[type="checkbox"]');

                // Відновлюємо збережений стан
                const savedState = JSON.parse(localStorage.getItem('teamVisibility')) || {};
                checkboxes.forEach(cb => {
                    const team = cb.dataset.team;
                    const isVisible = savedState[team] !== false; // за замовчуванням true
                    cb.checked = isVisible;
                    document.body.classList.toggle('hide-' + team, !isVisible);
                });

                // Відстежуємо зміни
                checkboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        const team = cb.dataset.team;
                        const isVisible = cb.checked;
                        document.body.classList.toggle('hide-' + team, !isVisible);

                        // Зберегти оновлений стан
                        const updatedState = {};
                        checkboxes.forEach(c => {
                            updatedState[c.dataset.team] = c.checked;
                        });
                        localStorage.setItem('teamVisibility', JSON.stringify(updatedState));
                    });
                });
                // === КІНЕЦЬ: Відновлення стану чекбоксів ===

        });
    document.addEventListener('click', function (e) {
        const menu = document.getElementById('settingsMenu');
        const settingsIcon = document.getElementById('settingsIcon');

        if (!menu.contains(e.target) && e.target !== settingsIcon) {
            menu.style.display = 'none';
        }
    });
</script>
</body>
</html>
